<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVM Nalbari - Admit Card</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #0A2240; --secondary: #0056b3; --border: #dee2e6; }
        body { font-family: 'Roboto', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        
        /* Login UI */
        .login-card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 380px; text-align: center; }
        .login-card input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid var(--border); border-radius: 6px; box-sizing: border-box; }
        .login-card button { width: 100%; padding: 12px; background: var(--secondary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Admit Card UI */
        #admitContainer { display: none; width: 210mm; background: white; padding: 15mm; border: 2px solid var(--primary); box-sizing: border-box; position: relative; }
        .header { display: flex; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .header img { width: 80px; margin-right: 20px; }
        .header h1 { font-family: 'Montserrat'; font-size: 22px; color: var(--primary); margin: 0; }

        .student-section { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .info-table { width: 70%; border-collapse: collapse; }
        .info-table td { padding: 6px 0; font-size: 14px; }
        .info-table td:first-child { font-weight: bold; width: 130px; }

        .image-box { text-align: center; width: 130px; }
        .photo-frame { width: 120px; height: 150px; border: 1px solid #ccc; background: #fafafa; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .photo-frame img { width: 100%; height: 100%; object-fit: cover; }
        
        .schedule table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .schedule th, .schedule td { border: 1px solid #ccc; padding: 8px; font-size: 13px; text-align: left; }
        .schedule th { background: var(--primary); color: white; }

        .footer { display: flex; justify-content: space-between; margin-top: 40px; }
        .sig-container { text-align: center; width: 180px; }
        .sig-container img { height: 45px; margin-bottom: 5px; }
        .sig-text { border-top: 1px solid black; padding-top: 5px; font-weight: bold; font-size: 12px; }

        @media print { .login-card, #printBtn { display: none !important; } #admitContainer { display: block !important; border: 1px solid #000; } }
    </style>
</head>
<body>

    <div class="login-card" id="loginUI">
        <h2>MVM NALBARI</h2>
        <p>Enter details to download Admit Card</p>
        <input type="text" id="sid" placeholder="Student ID (e.g. MVM001)">
        <input type="date" id="dob">
        <button onclick="fetchAdmitCard()">Get Admit Card</button>
        <p id="msg" style="color:red;"></p>
    </div>

    <div id="admitContainer">
        <div class="header">
            <img src="logo.png" alt="Logo">
            <div>
                <h1>MAHARISHI VIDYA MANDIR, NALBARI</h1>
                <p>BATIRAM ROAD, NALBARI, PIN-781335</p>
                <p><strong>ADMIT CARD: FINAL EXAMINATION 2025-26</strong></p>
            </div>
        </div>

        <div id="contentBody"></div>

        <button id="printBtn" style="margin-top:20px; padding:10px 25px; background:#28a745; color:white; border:none; border-radius:5px; cursor:pointer;" onclick="window.print()">Print Admit Card</button>
    </div>

    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>
    <script>
        const API = 'https://script.google.com/macros/s/AKfycbzwD9D276tD_ZpJxy64NX7n9vqeL-W8qedoA2nPAqqD5cudV3MmKfYaNNJrSX7IpbB84Q/exec';

        // SOLVING THE PROBLEM: This function converts Google Drive View URLs to Direct Image URLs
        function fixDriveUrl(url) {
            if (!url) return '';
            // Extract the File ID from the Google Drive link
            const match = url.match(/\/d\/(.+?)\//) || url.match(/id=(.+?)(&|$)/);
            if (match && match[1]) {
                // Return a direct-link format that works in <img> tags
                return `https://lh3.googleusercontent.com/u/0/d/${match[1]}`;
            }
            return url;
        }

        async function fetchAdmitCard() {
            const sid = document.getElementById('sid').value.toUpperCase();
            const dob = document.getElementById('dob').value;
            const msg = document.getElementById('msg');
            
            msg.innerText = "Processing...";
            
            try {
                const res = await fetch(API);
                const json = await res.json();
                const student = json.data.find(s => s['Student ID'] == sid);

                if (student) {
                    // Note: Your sheet date format must match (YYYY-MM-DD)
                    showAdmit(student);
                } else {
                    msg.innerText = "Student not found.";
                }
            } catch (e) {
                msg.innerText = "Error connecting to server.";
            }
        }

        function showAdmit(s) {
            let exams = '';
            for(let i=1; i<=10; i++) {
                if(s[`Date ${i}`]) exams += `<tr><td>${s[`Date ${i}`]}</td><td>${s[`Paper ${i}`]}</td><td></td><td></td></tr>`;
            }

            document.getElementById('contentBody').innerHTML = `
                <div class="student-section">
                    <table class="info-table">
                        <tr><td>Student Name</td><td>: ${s['Student Name']}</td></tr>
                        <tr><td>Father's Name</td><td>: ${s["Father's Name"]}</td></tr>
                        <tr><td>Student ID</td><td>: ${s['Student ID']}</td></tr>
                        <tr><td>Class / Roll</td><td>: ${s['Class']} - ${s['Section']} / ${s['Roll No']}</td></tr>
                    </table>
                    <div class="image-box">
                        <div class="photo-frame">
                            <img src="${fixDriveUrl(s['Photo URL'])}" alt="Student Photo">
                        </div>
                        <div id="qrcode" style="margin-top:10px;"></div>
                    </div>
                </div>
                <div class="schedule">
                    <table>
                        <thead><tr><th>Date</th><th>Subject</th><th>Student Sig</th><th>Invigilator</th></tr></thead>
                        <tbody>${exams}</tbody>
                    </table>
                </div>
                <div class="footer">
                    <div class="sig-container">
                        <img src="${fixDriveUrl(s['Signature URL'])}" alt="Sig">
                        <div class="sig-text">Student Signature</div>
                    </div>
                    <div class="sig-container">
                        <img src="sign.png" alt="Principal">
                        <div class="sig-text">Principal Signature</div>
                    </div>
                </div>
            `;

            document.getElementById('loginUI').style.display = 'none';
            document.getElementById('admitContainer').style.display = 'block';
            new QRCode(document.getElementById("qrcode"), { text: s['Student ID'], width: 80, height: 80 });
        }
    </script>
</body>
</html>
